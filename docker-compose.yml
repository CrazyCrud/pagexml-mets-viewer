services:
  viewer:
    build:
      context: .
    image: ocrd-page-mets-viewer:latest
    ports:
      - "8000:8000"
    command: >
      gunicorn "app:create_app()"
        --bind 0.0.0.0:8000
        --workers 1
        --threads 4
        --timeout 120
        --reload
        --log-level debug
        --reload-extra-file templates
        --reload-extra-file static
    environment:
      FLASK_ENV: "development"
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ./:/app:delegated
      - ./data/workspaces:/app/data/workspaces
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/ >/dev/null || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s