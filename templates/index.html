{% extends 'base.html' %}

{% block head %}
<title>PAGE-XML / METS Viewer</title>
{% endblock %}

{% block body %}

<section class="section pt-2">
  <div class="container">
    <div class="level mb-6">
      <div class="level-left">
        <div>
          <h1 class="title mb-1">PAGE-XML Viewer</h1>
          <p class="mb-1">Upload PAGE-XML and images, or start from METS, then browse and edit.</p>
          <div class="tags">
            <span id="topWsChip" class="tag is-info" style="display:none;"></span>
          </div>
        </div>
      </div>
      <div class="level-right">
        <div class="tabs is-toggle is-small">
          <ul>
            <li class="is-active"><a class="section-tab" data-target="workspace">Workspaces</a></li>
            <li class="is-disabled"><a class="section-tab" data-target="uploads" aria-disabled="true" tabindex="-1">Uploads</a></li>
            <li class="is-disabled"><a class="section-tab" data-target="files" aria-disabled="true" tabindex="-1">Files</a></li>
            <li class="is-disabled"><a class="section-tab" data-target="viewer" aria-disabled="true" tabindex="-1">Viewer</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-4" id="workspace">
      <header class="card-header">
        <p class="card-header-title">Workspaces</p>
        <div class="card-header-icon">
          <button id="btnRefreshWs" class="button is-small is-light">Refresh list</button>
        </div>
      </header>
      <div class="card-content">
        <p class="help mb-2">Load, delete or download PAGE-XML from previous uploads.</p>
        <div class="table-container">
          <table class="table is-fullwidth is-striped is-hoverable">
            <thead>
            <tr>
              <th>Label</th>
              <th>Pages</th>
              <th>Updated</th>
              <th style="width:200px;">Actions</th>
            </tr>
            </thead>
            <tbody id="workspaceTableBody">
            <tr><td colspan="4"><em>No workspaces yet</em></td></tr>
            </tbody>
          </table>
        </div>
        <p id="wsStatus" class="help mt-2"></p>
      </div>
    </div>

    <div id="wsBox" class="card mb-4 ws-card" style="display:none;">
      <header class="card-header">
        <p class="card-header-title">Active workspace</p>
      </header>
      <div class="card-content">
        <p class="mb-2">
          <strong>Workspace-ID on server:</strong>
          <span id="wsIdTag" class="tag is-info"></span>
        </p>
        <div class="field has-addons mb-3" style="max-width:420px;">
          <div class="control is-expanded">
            <input id="wsLabelInput" class="input" type="text" placeholder="Workspace name">
          </div>
          <div class="control">
            <button id="btnRenameWs" class="button is-link">Rename</button>
          </div>
        </div>
        <p id="wsLabelStatus" class="help mb-2"></p>
        <div class="buttons">
          <button id="btnCommit" class="button is-success" title="Regenerates normalized PAGE-XML with clean image paths" disabled>
            Normalize &amp; Commit
            <span id="commitBadge" class="tag is-warning is-light ml-2" style="display:none;">Pending changes</span>
          </button>
          <button id="btnDownloadWorkspace" class="button is-info is-light" disabled>Download PAGE-XML zip</button>
          <button id="btnReset" class="button is-light">Start Over</button>
        </div>
        <p class="help mb-2">Commit writes normalized PAGE-XML into this workspace (fixes image paths) and is what downloads will use.</p>
        <p id="commitNotice" class="help is-success" style="display:none;">Committed.</p>
      </div>
    </div>

    <div class="card mb-4" id="uploads">
      <header class="card-header">
        <p class="card-header-title">Uploads</p>
      </header>
      <div class="card-content">
        <div class="accordion">
          <div class="accordion-item">
            <button class="accordion-trigger" type="button" aria-expanded="false">0. (Optional) Upload METS</button>
            <div class="accordion-panel">
              <form id="formMETS" enctype="multipart/form-data">
                <div class="file has-name is-fullwidth">
                  <label class="file-label">
                    <input id="metsInput" class="file-input" type="file" name="file" accept=".xml">
                    <span class="file-cta">
                      <span class="icon"><i class="fas fa-file-alt"></i></span>
                      <span class="file-label">Choose METS (mets.xml)</span>
                    </span>
                    <span id="metsInputName" class="file-name">No file selected</span>
                  </label>
                </div>
                <div class="mt-3">
                  <button class="button is-dark" type="submit">Upload METS</button>
                </div>
              </form>

              <div id="fileGrpBox" class="mt-4" style="display:none;">
                <p class="mb-2"><strong>Detected file groups</strong></p>
                <div class="columns is-variable is-2">
                  <div class="column">
                    <label class="label">Image group</label>
                    <div id="imgGrpList" class="select is-fullwidth"><select id="selImgGrp"></select></div>
                  </div>
                  <div class="column">
                    <label class="label">PAGE-XML group</label>
                    <div id="pageGrpList" class="select is-fullwidth"><select id="selPageGrp"></select></div>
                  </div>
                </div>
              </div>

              <p id="metsUploadMsg" class="help mt-2"></p>
            </div>
          </div>

          <div class="accordion-item">
            <button class="accordion-trigger" type="button" aria-expanded="false">1. Upload PAGE-XML files</button>
            <div class="accordion-panel">
              <form id="formPages" enctype="multipart/form-data">
                <div class="file has-name is-fullwidth">
                  <label class="file-label">
                    <input id="pagesInput" class="file-input" type="file" name="files[]" multiple accept=".xml">
                    <span class="file-cta">
                      <span class="icon"><i class="fas fa-copy"></i></span>
                      <span class="file-label">Choose PAGE-XML files</span>
                    </span>
                    <span id="pagesInputName" class="file-name">No files selected</span>
                  </label>
                </div>
                <div class="mt-3">
                  <button class="button is-link" type="submit">Upload PAGE-XML</button>
                </div>
              </form>
              <p id="pagesUploadMsg" class="help mt-2"></p>

              <div id="missingPagesWrap" class="content mt-3" style="display:none;">
                <p><strong>Missing PAGE-XML (from METS):</strong></p>
                <ul id="missingPagesList"></ul>
              </div>
            </div>
          </div>

          <div class="accordion-item" id="imagesBox" style="display:none;">
            <button class="accordion-trigger" type="button" aria-expanded="false">2. Upload images</button>
            <div class="accordion-panel">
              <div id="missingWrap" class="content">
                <p><strong>Missing images:</strong></p>
                <ul id="missingList"></ul>
              </div>
              <form id="formImages" class="mt-3" enctype="multipart/form-data">
                <div class="file has-name is-fullwidth">
                  <label class="file-label">
                    <input id="imagesInput" class="file-input" type="file" name="files[]" multiple
                           accept=".tif,.tiff,.png,.jpg,.jpeg,.bmp,.webp,.gif,.jp2">
                    <span class="file-cta">
                      <span class="icon"><i class="fas fa-images"></i></span>
                      <span class="file-label">Choose images</span>
                    </span>
                    <span id="imagesInputName" class="file-name">No files selected</span>
                  </label>
                </div>
                <div class="mt-3">
                  <button class="button is-primary" type="submit">Upload images</button>
                </div>
              </form>
              <p id="imagesUploadMsg" class="help mt-2"></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4" id="files" style="display:none;">
      <header class="card-header">
        <p class="card-header-title">Files in workspace</p>
      </header>
      <div class="card-content">
        <h2 class="title is-6">PAGE-XML files</h2>
        <div class="table-container">
          <table class="table is-fullwidth is-striped is-hoverable">
            <thead>
            <tr>
              <th>File</th>
            </tr>
            </thead>
            <tbody id="pagesTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" id="viewer" style="display:none;">
      <header class="card-header">
        <p class="card-header-title">Viewer</p>
      </header>
      <div class="card-content">
      <p class="mb-2"><strong>PAGE:</strong> <span id="curPage"></span></p>

      <div id="stats-panel" class="box" style="margin-top:.75rem; display:none;">
        <div id="stats-content"></div>
      </div>

      <div class="field is-grouped mb-3">
        <div class="mr-4">
          <button id="btnFit" class="button is-small">Fit</button>
          <button id="btnZoomIn" class="button is-small">+</button>
          <button id="btnZoomOut" class="button is-small">-</button>
        </div>
        <p class="control"><button id="modeSelect" class="button is-small is-link is-light">Select</button></p>
        <p class="control"><button id="modeAddRegion" class="button is-small is-light">Add Text Region</button></p>
        <p class="control"><button id="modeAddLine" class="button is-small is-light">Add Text Line</button></p>
        <p class="control"><span id="modeStatus" class="tag is-light">Mode: Select</span></p>
      </div>

      <div id="osd"
           style="width:100%; height:70vh; background:#111; position:relative; border:1px solid #333;"></div>
      <div id="linePopover" class="line-popover box" style="display:none;">
        <div class="is-flex is-justify-content-space-between is-align-items-center mb-2">
          <div>
            <p class="is-size-6 has-text-weight-semibold" id="linePopoverTitle">Edit line</p>
            <p class="help mb-0" id="linePopoverLabel">TextLine</p>
          </div>
          <button class="delete" aria-label="close" id="linePopoverClose"></button>
        </div>
        <div class="field">
          <label class="label is-size-7">Transcription</label>
          <div class="control">
            <textarea class="textarea" rows="3" id="linePopoverInput"></textarea>
          </div>
        </div>
        <p class="help" id="linePopoverStatus"></p>
        <div class="buttons is-right mt-2">
          <button class="button is-success is-small" id="linePopoverSave">Save</button>
          <button class="button is-light is-small" id="linePopoverCancel">Cancel</button>
        </div>
      </div>

      <div class="field is-grouped is-grouped-multiline mt-3">
        <div class="control">
          <label class="checkbox"><input type="checkbox" id="cbRegions" checked> Show regions</label>
        </div>
        <div class="control">
          <label class="checkbox"><input type="checkbox" id="cbLines" checked> Show lines</label>
        </div>
      </div>
      <div id="legend" class="legend">
        <span class="chip" style="background:#0080ff22;border:1px solid #0080ff">Text</span>
        <span class="chip" style="background:#ffa50022;border:1px solid #ffa500">Table</span>
        <span class="chip" style="background:#7c4dff22;border:1px solid #7c4dff">Image</span>
      </div>

      <div class="box mt-4" id="transcriptionBox" style="display:none;">
        <div class="is-flex is-justify-content-space-between is-align-items-center mb-2">
          <div>
            <h3 class="title is-6 mb-1">Text line transcription</h3>
            <p class="help mb-0">Enter text for each TextLine and save it back to the PAGE-XML.</p>
          </div>
          <div class="buttons">
            <button id="btnSaveTranscription" class="button is-primary">Save transcription</button>
          </div>
        </div>
        <div id="lineEditor" class="line-editor"></div>
        <p id="transcriptionStatus" class="help mt-2"></p>
      </div>
      </div>
    </div>

  </div>
</section>

<!-- Line edit modal -->
<div class="modal" id="lineModal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title" id="lineModalTitle">Edit line</p>
      <button class="delete" aria-label="close" id="lineModalClose"></button>
    </header>
    <section class="modal-card-body">
      <div class="field">
        <label class="label" id="lineModalLabel">TextLine</label>
        <div class="control">
          <textarea class="textarea" rows="3" id="lineModalInput"></textarea>
        </div>
      </div>
      <p class="help" id="lineModalStatus"></p>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" id="lineModalSave">Save</button>
      <button class="button" id="lineModalCancel">Cancel</button>
    </footer>
  </div>
</div>

{% endblock %}
