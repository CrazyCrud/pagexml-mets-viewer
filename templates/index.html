{% extends 'base.html' %}

{% block head %}
<title>PAGE-XML / METS Viewer</title>
{% endblock %}

{% block body %}

<section class="section pt-2">
  <div class="container">
    <h1 class="title">PAGE-XML &amp; METS Viewer</h1>
    <p class="subtitle">
      Either upload PAGE-XML files and images directly, or upload a METS and check what's needed.
    </p>

    <div class="box" id="workspaceListBox">
      <div class="level">
        <div class="level-left">
          <h2 class="title is-5 mb-0">Existing workspaces</h2>
        </div>
        <div class="level-right">
          <button id="btnRefreshWs" class="button is-small is-light">Refresh list</button>
        </div>
      </div>
      <p class="help mb-2">Load, delete or download PAGE-XML from previous uploads.</p>
      <div class="table-container">
        <table class="table is-fullwidth is-striped is-hoverable">
          <thead>
          <tr>
            <th>Label</th>
            <th>Pages</th>
            <th>Updated</th>
            <th style="width:200px;">Actions</th>
          </tr>
          </thead>
          <tbody id="workspaceTableBody">
          <tr><td colspan="4"><em>No workspaces yet</em></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="wsBox" class="box" style="display:none;">
      <p class="mb-2">
        <strong>Workspace-ID on server:</strong>
        <span id="wsIdTag" class="tag is-info"></span>
      </p>
      <div class="buttons">
        <button id="btnCommit" class="button is-success" disabled>Commit</button>
        <button id="btnDownloadWorkspace" class="button is-info is-light" disabled>Download PAGE-XML zip</button>
        <button id="btnReset" class="button is-light">Start Over</button>
      </div>
      <p id="commitNotice" class="help is-success" style="display:none;">Committed.</p>
    </div>

    <div class="box">
      <h2 class="title is-5">0. (Optional) Upload METS</h2>
      <form id="formMETS" enctype="multipart/form-data">
        <div class="file has-name is-fullwidth">
          <label class="file-label">
            <input id="metsInput" class="file-input" type="file" name="file" accept=".xml">
            <span class="file-cta">
              <span class="icon"><i class="fas fa-file-alt"></i></span>
              <span class="file-label">Choose METS (mets.xml)</span>
            </span>
            <span id="metsInputName" class="file-name">No file selected</span>
          </label>
        </div>
        <div class="mt-3">
          <button class="button is-dark" type="submit">Upload METS</button>
        </div>
      </form>

      <div id="fileGrpBox" class="mt-4" style="display:none;">
        <p class="mb-2"><strong>Detected file groups</strong></p>
        <div class="columns is-variable is-2">
          <div class="column">
            <label class="label">Image group</label>
            <div id="imgGrpList" class="select is-fullwidth"><select id="selImgGrp"></select></div>
          </div>
          <div class="column">
            <label class="label">PAGE-XML group</label>
            <div id="pageGrpList" class="select is-fullwidth"><select id="selPageGrp"></select></div>
          </div>
        </div>
      </div>

      <p id="metsUploadMsg" class="help mt-2"></p>
    </div>

    <div class="box">
      <h2 class="title is-5">1. Upload PAGE-XML files</h2>
      <form id="formPages" enctype="multipart/form-data">
        <div class="file has-name is-fullwidth">
          <label class="file-label">
            <input id="pagesInput" class="file-input" type="file" name="files[]" multiple accept=".xml">
            <span class="file-cta">
              <span class="icon"><i class="fas fa-copy"></i></span>
              <span class="file-label">Choose PAGE-XML files</span>
            </span>
            <span id="pagesInputName" class="file-name">No files selected</span>
          </label>
        </div>
        <div class="mt-3">
          <button class="button is-link" type="submit">Upload PAGE-XML</button>
        </div>
      </form>
      <p id="pagesUploadMsg" class="help mt-2"></p>

      <div id="missingPagesWrap" class="content mt-3" style="display:none;">
        <p><strong>Missing PAGE-XML (from METS):</strong></p>
        <ul id="missingPagesList"></ul>
      </div>
    </div>

    <div class="box" id="imagesBox" style="display:none;">
      <h2 class="title is-5">2. Upload images</h2>
      <div id="missingWrap" class="content">
        <p><strong>Missing images:</strong></p>
        <ul id="missingList"></ul>
      </div>
      <form id="formImages" class="mt-3" enctype="multipart/form-data">
        <div class="file has-name is-fullwidth">
          <label class="file-label">
            <input id="imagesInput" class="file-input" type="file" name="files[]" multiple
                   accept=".tif,.tiff,.png,.jpg,.jpeg,.bmp,.webp,.gif,.jp2">
            <span class="file-cta">
              <span class="icon"><i class="fas fa-images"></i></span>
              <span class="file-label">Choose images</span>
            </span>
            <span id="imagesInputName" class="file-name">No files selected</span>
          </label>
        </div>
        <div class="mt-3">
          <button class="button is-primary" type="submit">Upload images</button>
        </div>
      </form>
      <p id="imagesUploadMsg" class="help mt-2"></p>
    </div>

    <div class="box" id="pagesBox" style="display:none;">
      <h2 class="title is-5">3. Open a PAGE</h2>
      <div class="table-container">
        <table class="table is-fullwidth is-striped is-hoverable">
          <thead>
          <tr>
            <th>File</th>
          </tr>
          </thead>
          <tbody id="pagesTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="box" id="viewerBox" style="display:none;">
      <h2 class="title is-5">Viewer</h2>
      <p class="mb-2"><strong>PAGE:</strong> <span id="curPage"></span></p>

      <div id="stats-panel" class="box" style="margin-top:.75rem; display:none;">
        <div id="stats-content"></div>
      </div>

      <div class="buttons mb-2">
        <button id="btnFit" class="button is-small">Fit</button>
        <button id="btnZoomIn" class="button is-small">+</button>
        <button id="btnZoomOut" class="button is-small">-</button>
      </div>

      <div id="osd"
           style="width:100%; height:70vh; background:#111; position:relative; border:1px solid #333;"></div>

      <div class="field is-grouped is-grouped-multiline mt-3">
        <div class="control">
          <label class="checkbox"><input type="checkbox" id="cbRegions" checked> Show regions</label>
        </div>
        <div class="control">
          <label class="checkbox"><input type="checkbox" id="cbLines" checked> Show lines</label>
        </div>
      </div>
      <div id="legend" class="legend">
        <span class="chip" style="background:#0080ff22;border:1px solid #0080ff">Text</span>
        <span class="chip" style="background:#ffa50022;border:1px solid #ffa500">Table</span>
        <span class="chip" style="background:#7c4dff22;border:1px solid #7c4dff">Image</span>
      </div>

      <div class="box mt-4" id="transcriptionBox" style="display:none;">
        <div class="is-flex is-justify-content-space-between is-align-items-center mb-2">
          <div>
            <h3 class="title is-6 mb-1">Text line transcription</h3>
            <p class="help mb-0">Enter text for each TextLine and save it back to the PAGE-XML.</p>
          </div>
          <div class="buttons">
            <button id="btnSaveTranscription" class="button is-primary">Save transcription</button>
          </div>
        </div>
        <div id="lineEditor" class="line-editor"></div>
        <p id="transcriptionStatus" class="help mt-2"></p>
      </div>
    </div>

  </div>
</section>

{% endblock %}
